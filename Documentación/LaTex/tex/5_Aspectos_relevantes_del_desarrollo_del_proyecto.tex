\capitulo{5}{Aspectos relevantes del desarrollo del proyecto}

\section{Tratamiento de los roles de los usuarios}
Durante el progreso en la aplicación de partida, nos dimos cuenta de que el tratamiento de los roles podía también ser realizado mediante la cotejación del mismo contra la \textit{API} de UBUVirtual en lugar de tener los roles almacenados en la base de datos junto con los usuarios autorizados. Por otro lado, cabe mencionar que en la aplicación de partida no se estableció ningún tratamiento de roles de usuario, aunque se mencionara.

Inicialmente se decidió llevar a cabo el objetivo inicial de tratamiento de roles, es decir, mediante la definición de los mismos en la base de datos con su posterior consulta a la hora de definir el usuario, aunque después nos dimos cuenta de que la \textit{API} de UBUVirtual podría proporcionarnos estos roles, los cuales vienen dados a cada usuario en la asignatura correspondiente. Para ellos utilizamos las funciones proporcionadas por \textit{Moodle} para realizar peticiones a nuestra \textit{API Rest} (sección \ref{sec:api-rest}), que en este caso es UBUVirtual. En dicho listado de funciones (~\cite{moodle:web-service-api-functions}) encontramos la función \textit{core_enrol_get_enrolled_users}, la cual nos permitirá conocer los usuarios de la asignatura, así como su rol en la misma y más información variada de cada uno de los participantes. Dicha función nos muestra esta información en forma de diccionario \textit{JSON} desde el que buscaremos al usuario correspondiente para así conocer su rol en la asignatura correspondiente. Dicha información nos es presentada con la siguiente estructura:~\ref{fig:user-info-JSON}
\imagen{Información de usuario JSON}{Estructura de la información proporcionada por la API en formato JSON}

Como se puede apreciar en el campo \textit{roles} nos encontramos con el rol correspondiente del usuario en cuestión, que en este caso es \textit{Profesor} y el id de dicho rol es \textit{3}

\section{Obtención de los Modelos}
La idea inicial de la aplicación era que los modelos proporcionados para su posterior visualización se administraran de manera local, es decir, en una carpeta con todos los modelos. Llegados al punto de pensar cómo podíamos proporcionar al usuario los modelos óseos privados, decidimos que la mejor manera de hacerlo era mediante la administración de dichos modelos como recursos en la \textit{API} de UBUVirtual, siendo estos recursos invisibles para el alumno y a los que solo el profesor tenga acceso para modificar. Para ello, recurrimos de nuevo a las funciones \textit{API Rest} siendo esta vez la función \textit{mod_resource_get_resources_by_courses} la elegida ~\cite{moodle:web-service-api-functions}. Dicha función nos ofrece la información de los recursos presentes en la \textit{API} de UBUVirtual en los cursos correspondientes. En el caso de no seleccionar un curso en concreto, nos devuelve cada uno de los recursos a los que dicho usuario puede acceder. La información resultante tiene la siguiente estructura:~\ref{fig:JSON-resources}
\imagen{Recursos JSON}{Estructura de la información proporcionada por la API en formato JSON}

De esta manera podemos acceder al nombre de recurso con su correspondiente extensión y comprobar que es del curso correspondiente mediante el campo \textit{course}.

Pero posteriormente, la Universidad de Burgos nos proporcionó un servidor privado, de nombre "arquimedes" en el que podemos desplegar nuestra \textit{API} sin necesitar por ello todo lo mencionado anteriormente acerca de los albergar los modelos como recursos de \textit{UBUVirtual}, ya que podremos albergarlos en nuestro servidor.

\section{Instalación y configuración de Moodle como API Rest}
Para poder realizar las pruebas pertinentes en cada parte del proyecto, hemos decidido que lo ideal es tener instalado \textit{Moodle} de manera local para realizar las llamadas, así como la subida de recursos, asignación de roles, etc, sin tener que depender de un tutor (el cual puede crear una asignatura ficticia y realizar las pruebas ahí). Por ello, hemos realizado la instalación de \textit{Moodle} con un paquete instalador (sección ~\ref{sec:moodle-local}) para \textit{Windows} en el cual viene incluido \textit{XAMPP}~\cite{wiki:xampp} así como \textit{MySql}~\cite{wiki:mysql}.

Una vez instalado \textit{Moodle} y creado un curso y un alumno para poder realizar las pruebas, nos hemos encontrado con el problema de que la \textit{API} no era una \textit{API Rest}~\ref{sec:api-rest} ya que a la hora de realizar las peticiones necesarias para la obtención de información del usuario se nos denegaba el acceso. Para poder solucionar este problema hemos tenido que configurar nuestra \textit{API} cambiando los parámetros correspondientes.

En primer lugar debemos tener un usuario con el rol de administrador de la plataforma para poder acceder a la \textit{Administración del sitio} para poder activar los servicios web que por defecto vienen desactivados. Deberemos dirigirnos a \textit{Administración del sitio--Características avanzadas} y habilitar los servicios web. Una vez hecho esto deberemos activar el protocolo \textit{Rest}, que básicamente es el protocolo seguido por una \textit{API Rest} (sección~\ref{sec:api-rest}), el cual se accede mediante \textit{Administración del sitio -- Extensiones -- Servicios Web -- Administrar protocolos} y habilitamos dicho protocolo.

A su vez, para que podamos acceder a dichas funcionalidades, además de tener que estar el servicio web y el protocolo activado, lo usuarios deben tener una ficha o \textit{token} el cual los identifique de manera única. Para generar desde nuestra \textit{API} dichos \textit{tokens} nos dirigiremos a \textit{Administración del sitio -- Extensiones -- Servicios web -- Administrar tokens} y ahí generaremos los tokens para los usuarios. De esta manera, cada usuario tendrá un identificador único para realizar las peticiones correspondientes~\cite{moodle:api-rest-config}.